<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uniswap V3 Position Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .header a {
            color: white;
            text-decoration: underline;
            font-weight: bold;
            margin-top: 10px;
            display: inline-block;
        }
        
        .header a:hover {
            color: #f8f9fa;
        }

        .form-container {
            padding: 40px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 1rem;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group .help-text {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }

        .action-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .action-btn:active {
            transform: translateY(0);
        }

        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .results {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
            display: none;
        }

        .results.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-item {
            margin-bottom: 20px;
        }

        .result-item:last-child {
            margin-bottom: 0;
        }

        .result-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .result-value {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            word-break: break-all;
            position: relative;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 5px 10px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .copy-btn:hover {
            background: #5a67d8;
        }

        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .error.show {
            display: block;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .pool-info {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .pool-info.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .pool-info-title {
            font-weight: 600;
            color: #0050b3;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .pool-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #d9d9d9;
        }

        .pool-info-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .pool-info-label {
            font-weight: 500;
            color: #333;
        }

        .pool-info-value {
            font-family: 'Courier New', monospace;
            color: #0050b3;
            word-break: break-all;
        }

        .network-info {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .network-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .network-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #52c41a;
        }

        .network-indicator.disconnected {
            background: #f5222d;
        }

        .settings-btn {
            background: transparent;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .settings-btn:hover {
            background: #f0f0f0;
        }

        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .settings-modal.show {
            display: flex;
        }

        .settings-content {
            background: white;
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .settings-title {
            font-weight: 600;
            font-size: 1.2rem;
            color: #333;
        }

        .close-btn {
            background: transparent;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
            transition: color 0.2s;
        }

        .close-btn:hover {
            color: #333;
        }

        .settings-form-group {
            margin-bottom: 15px;
        }

        .settings-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .cancel-btn {
            padding: 8px 16px;
            background: #f0f0f0;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cancel-btn:hover {
            background: #e0e0e0;
        }

        .save-btn {
            padding: 8px 16px;
            background: #1890ff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .save-btn:hover {
            background: #096dd9;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            border-bottom: 2px solid #1890ff;
            color: #1890ff;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .fees-info {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .fees-info.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¦„ Uniswap V3 Position Manager</h1>
            <p>æŸ¥çœ‹æ± å­æƒ…å†µã€ç§»é™¤æµåŠ¨æ€§ã€å½’é›†æ‰‹ç»­è´¹</p>
            <a href="https://bscscan.com/address/0xC36442b4a4522E871399CD717aBDD847Ab11FE88#writeContract" target="_blank" id="positionManagerLink">åˆçº¦äº¤äº’</a>
        </div>

        <div class="form-container">
            <div class="network-info">
                <div class="network-status">
                    <div class="network-indicator" id="networkIndicator"></div>
                    <span id="networkStatus">è¿æ¥ä¸­...</span>
                </div>
                <button class="settings-btn" id="settingsBtn">âš™ï¸ è®¾ç½®</button>
            </div>

            <div class="tabs">
                <div class="tab active" data-tab="query">æŸ¥è¯¢æ± å­</div>
                <div class="tab" data-tab="remove">ç§»é™¤æµåŠ¨æ€§</div>
                <div class="tab" data-tab="collect">å½’é›†æ‰‹ç»­è´¹</div>
            </div>

            <!-- æŸ¥è¯¢æ± å­ Tab -->
            <div class="tab-content active" id="queryTab">
                <form id="queryForm">
                    <div class="form-group">
                        <label for="queryTokenId">Token ID</label>
                        <input type="number" id="queryTokenId" name="tokenId" required placeholder="ä¾‹å¦‚: 60375">
                        <div class="help-text">æ‚¨çš„ LP Position Token ID</div>
                    </div>

                    <button type="submit" class="action-btn" id="queryBtn">
                        ğŸ” æŸ¥è¯¢æ± å­ä¿¡æ¯
                    </button>
                </form>
            </div>

            <!-- ç§»é™¤æµåŠ¨æ€§ Tab -->
            <div class="tab-content" id="removeTab">
                <form id="removeForm">
                    <div class="form-group">
                        <label for="removeTokenId">Token ID</label>
                        <input type="number" id="removeTokenId" name="tokenId" required placeholder="ä¾‹å¦‚: 60375">
                        <div class="help-text">æ‚¨çš„ LP Position Token ID</div>
                    </div>

                    <div class="form-group">
                        <label for="liquidity">æµåŠ¨æ€§æ•°é‡ (ç™¾åˆ†æ¯”)</label>
                        <input type="number" id="liquidity" name="liquidity" required min="1" max="100" value="100" placeholder="1-100">
                        <div class="help-text">è¦ç§»é™¤çš„æµåŠ¨æ€§ç™¾åˆ†æ¯”ï¼Œ100è¡¨ç¤ºå…¨éƒ¨ç§»é™¤</div>
                    </div>

                    <div class="form-group">
                        <label for="amount0Min">Token0 æœ€å°æ•°é‡</label>
                        <input type="text" id="amount0Min" name="amount0Min" required value="0" placeholder="0">
                        <div class="help-text">æ¥æ”¶çš„ Token0 æœ€å°æ•°é‡ (é˜²æ»‘ç‚¹)</div>
                    </div>

                    <div class="form-group">
                        <label for="amount1Min">Token1 æœ€å°æ•°é‡</label>
                        <input type="text" id="amount1Min" name="amount1Min" required value="0" placeholder="0">
                        <div class="help-text">æ¥æ”¶çš„ Token1 æœ€å°æ•°é‡ (é˜²æ»‘ç‚¹)</div>
                    </div>

                    <button type="submit" class="action-btn" id="removeBtn">
                        ğŸ”¥ ç”Ÿæˆç§»é™¤æµåŠ¨æ€§å‚æ•°
                    </button>
                </form>
            </div>

            <!-- å½’é›†æ‰‹ç»­è´¹ Tab -->
            <div class="tab-content" id="collectTab">
                <form id="collectForm">
                    <div class="form-group">
                        <label for="collectTokenId">Token ID</label>
                        <input type="number" id="collectTokenId" name="tokenId" required placeholder="ä¾‹å¦‚: 60375">
                        <div class="help-text">æ‚¨çš„ LP Position Token ID</div>
                    </div>

                    <div class="form-group">
                        <label for="recipient">æ¥æ”¶åœ°å€</label>
                        <input type="text" id="recipient" name="recipient">
                        <div class="help-text">æ¥æ”¶æ‰‹ç»­è´¹çš„é’±åŒ…åœ°å€</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="amount0Max">Token0 æœ€å¤§æ•°é‡</label>
                        <input type="text" id="amount0Max" name="amount0Max" value="340282366920938463463374607431768211455">
                        <div class="help-text">è¦å½’é›†çš„ Token0 æœ€å¤§æ•°é‡</div>
                    </div>

                    <div class="form-group">
                        <label for="amount1Max">Token1 æœ€å¤§æ•°é‡</label>
                        <input type="text" id="amount1Max" name="amount1Max" value="340282366920938463463374607431768211455">
                        <div class="help-text">è¦å½’é›†çš„ Token1 æœ€å¤§æ•°é‡</div>
                    </div>

                    <button type="submit" class="action-btn" id="collectBtn">
                        ğŸ’° ç”Ÿæˆå½’é›†æ‰‹ç»­è´¹å‚æ•°
                    </button>
                </form>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨æŸ¥è¯¢å¹¶ç”Ÿæˆæ•°æ®...</p>
            </div>

            <div class="error" id="error"></div>

            <div class="pool-info" id="poolInfo">
                <div class="pool-info-title">ğŸŠ æ± å­ä¿¡æ¯</div>
                <div class="pool-info-item">
                    <div class="pool-info-label">Token ID:</div>
                    <div class="pool-info-value" id="infoTokenId"></div>
                </div>
                <div class="pool-info-item">
                    <div class="pool-info-label">æµåŠ¨æ€§:</div>
                    <div class="pool-info-value" id="infoLiquidity"></div>
                </div>
                <div class="pool-info-item">
                    <div class="pool-info-label">Token0:</div>
                    <div class="pool-info-value" id="infoToken0"></div>
                </div>
                <div class="pool-info-item">
                    <div class="pool-info-label">Token1:</div>
                    <div class="pool-info-value" id="infoToken1"></div>
                </div>
                <div class="pool-info-item">
                    <div class="pool-info-label">æ‰‹ç»­è´¹ç‡:</div>
                    <div class="pool-info-value" id="infoFee"></div>
                </div>
                <div class="pool-info-item">
                    <div class="pool-info-label">ä»·æ ¼åŒºé—´ä¸‹é™:</div>
                    <div class="pool-info-value" id="infoTickLower"></div>
                </div>
                <div class="pool-info-item">
                    <div class="pool-info-label">ä»·æ ¼åŒºé—´ä¸Šé™:</div>
                    <div class="pool-info-value" id="infoTickUpper"></div>
                </div>
            </div>

            <div class="fees-info" id="feesInfo">
                <div class="pool-info-title">ğŸ’° å¯å½’é›†æ‰‹ç»­è´¹</div>
                <div class="pool-info-item">
                    <div class="pool-info-label">Token0 æ‰‹ç»­è´¹:</div>
                    <div class="pool-info-value" id="infoFee0"></div>
                </div>
                <div class="pool-info-item">
                    <div class="pool-info-label">Token1 æ‰‹ç»­è´¹:</div>
                    <div class="pool-info-value" id="infoFee1"></div>
                </div>
                
            </div>

            <div class="results" id="results">
                <div class="result-item">
                    <div class="result-label">
                        ğŸ“ è°ƒç”¨å‚æ•°
                    </div>
                    <div class="result-value" id="paramsResult">
                        <button class="copy-btn" onclick="copyToClipboard('paramsResult')">å¤åˆ¶</button>
                        <span id="paramsValue"></span>
                    </div>
                </div>

                <div class="result-item">
                    <div class="result-label">
                        â° Deadline (uint256)
                    </div>
                    <div class="result-value" id="deadlineResult">
                        <button class="copy-btn" onclick="copyToClipboard('deadlineResult')">å¤åˆ¶</button>
                        <span id="deadlineValue"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®å¼¹çª— -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <div class="settings-header">
                <div class="settings-title">ç½‘ç»œè®¾ç½®</div>
                <button class="close-btn" id="closeSettingsBtn">&times;</button>
            </div>
            <div class="settings-form-group network-selection">
                <label for="networkSelect">é€‰æ‹©ç½‘ç»œ</label>
                <select id="networkSelect" class="form-control">
                    <option value="bsc">BSC (å¸å®‰æ™ºèƒ½é“¾)</option>
                    <option value="base">Base</option>
                    <option value="ethereum">Ethereum (ä»¥å¤ªåŠ)</option>
                </select>
                <div class="help-text">é€‰æ‹©è¦è¿æ¥çš„åŒºå—é“¾ç½‘ç»œ</div>
            </div>
            <div class="network-details">
                <div class="settings-form-group">
                    <label for="rpcUrl">RPC URL</label>
                    <input type="text" id="rpcUrl" class="form-control" value="https://bsc-dataseed1.binance.org/">
                    <div class="help-text">åŒºå—é“¾ç½‘ç»œçš„ RPC ç«¯ç‚¹</div>
                </div>
                <div class="settings-form-group">
                    <label for="contractAddress">PositionManager åˆçº¦åœ°å€</label>
                    <input type="text" id="contractAddress" class="form-control" value="0x7b8A01B39D58278b5DE7e48c8449c9f4F5170613">
                    <div class="help-text">Uniswap V3 PositionManager åˆçº¦åœ°å€</div>
                </div>
            </div>
            <div class="settings-actions">
                <button class="cancel-btn" id="cancelSettingsBtn">å–æ¶ˆ</button>
                <button class="save-btn" id="saveSettingsBtn">ä¿å­˜å¹¶è¿æ¥</button>
            </div>
        </div>
    </div>
    
    <style>
        /* ä¼˜åŒ–è®¾ç½®å¯¹è¯æ¡†æ ·å¼ */
        .network-selection {
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        
        .network-selection select {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 6px;
            font-weight: 500;
        }
        
        .network-details {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .save-btn {
            background: #1890ff;
            font-weight: 500;
            padding: 10px 20px;
        }
    </style>

    <script>
        // å…¨å±€å˜é‡
        let provider;
        let contract;
        let positionManagerABI;
        let isConnected = false;
        let currentPosition = null;

        // ç½‘ç»œé…ç½®
        const networkConfigs = {
            bsc: {
                name: 'BSC',
                rpcUrl: 'https://bsc-dataseed1.binance.org/',
                contractAddress: '0x7b8a01b39d58278b5de7e48c8449c9f4f5170613',
                explorerUrl: 'https://bscscan.com/address/'
            },
            base: {
                name: 'Base',
                rpcUrl: 'https://mainnet.base.org',
                contractAddress: '0x03a520b32c04bf3beef7beb72e919cf822ed34f1',
                explorerUrl: 'https://basescan.org/address/'
            },
            ethereum: {
                name: 'Ethereum',
                rpcUrl: 'https://eth.llamarpc.com',
                contractAddress: '0xC36442b4a4522E871399CD717aBDD847Ab11FE88',
                explorerUrl: 'https://etherscan.io/address/'
            }
        };

        // é»˜è®¤è®¾ç½®
        const defaultSettings = {
            network: 'bsc',
            ...networkConfigs.bsc
        };

        // å½“å‰è®¾ç½®
        let currentSettings = { ...defaultSettings };

        // åˆå§‹åŒ– Web3 è¿æ¥
        async function initWeb3() {
            try {
                // æ›´æ–°ç½‘ç»œçŠ¶æ€ä¸ºè¿æ¥ä¸­
                document.getElementById('networkIndicator').classList.add('disconnected');
                document.getElementById('networkStatus').textContent = 'è¿æ¥ä¸­...';

                // åˆ›å»º provider
                provider = new ethers.providers.JsonRpcProvider(currentSettings.rpcUrl);
                
                // æ£€æŸ¥è¿æ¥
                const network = await provider.getNetwork();
                const blockNumber = await provider.getBlockNumber();
                
                // åŠ è½½ ABI
                await loadABI();
                
                // åˆ›å»ºåˆçº¦å®ä¾‹
                contract = new ethers.Contract(
                    currentSettings.contractAddress,
                    positionManagerABI,
                    provider
                );
                
                // æ›´æ–°ç½‘ç»œçŠ¶æ€ä¸ºå·²è¿æ¥
                document.getElementById('networkIndicator').classList.remove('disconnected');
                document.getElementById('networkStatus').textContent = `å·²è¿æ¥åˆ° ${currentSettings.name || 'BSC'} ç½‘ç»œ (åŒºå—: ${blockNumber})`;
                isConnected = true;
                
                // æ›´æ–°åˆçº¦äº¤äº’é“¾æ¥
                updatePositionManagerLink();
                
                console.log(`å·²è¿æ¥åˆ° ${currentSettings.name || 'åŒºå—é“¾'} ç½‘ç»œï¼Œé“¾ ID: ${network.chainId}ï¼Œå½“å‰åŒºå—: ${blockNumber}`);
            } catch (error) {
                console.error(`è¿æ¥ ${currentSettings.name || 'åŒºå—é“¾'} ç½‘ç»œå¤±è´¥:`, error);
                document.getElementById('networkIndicator').classList.add('disconnected');
                document.getElementById('networkStatus').textContent = 'è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®';
                isConnected = false;
                showError(`è¿æ¥ ${currentSettings.name || 'åŒºå—é“¾'} ç½‘ç»œå¤±è´¥: ${error.message}`);
            }
        }

        // åŠ è½½ ABI
        async function loadABI() {
            try {
                // ä½¿ç”¨ V3 PositionManager ABI
                positionManagerABI = [
                    // positions å‡½æ•° - æŸ¥è¯¢æ± å­ä¿¡æ¯
                    "function positions(uint256 tokenId) external view returns (uint96 nonce, address operator, address token0, address token1, uint24 fee, int24 tickLower, int24 tickUpper, uint128 liquidity, uint256 feeGrowthInside0LastX128, uint256 feeGrowthInside1LastX128, uint128 tokensOwed0, uint128 tokensOwed1)",
                    
                    // decreaseLiquidity å‡½æ•° - ç§»é™¤æµåŠ¨æ€§
                    "function decreaseLiquidity(tuple(uint256 tokenId, uint128 liquidity, uint256 amount0Min, uint256 amount1Min, uint256 deadline)) external payable returns (uint256 amount0, uint256 amount1)",
                    
                    // collect å‡½æ•° - å½’é›†æ‰‹ç»­è´¹
                    "function collect(tuple(uint256 tokenId, address recipient, uint128 amount0Max, uint128 amount1Max)) external payable returns (uint256 amount0, uint256 amount1)"
                ];
            } catch (error) {
                console.error("åŠ è½½ ABI å¤±è´¥:", error);
                showError(`åŠ è½½ ABI å¤±è´¥: ${error.message}`);
            }
        }

        // æ›´æ–°åˆçº¦äº¤äº’é“¾æ¥
        function updatePositionManagerLink() {
            const link = document.getElementById('positionManagerLink');
            if (link) {
                link.href = `${currentSettings.explorerUrl}${currentSettings.contractAddress}#writeContract`;
            }
        }

        // æŸ¥è¯¢æ± å­ä¿¡æ¯
        async function queryPosition(tokenId) {
            try {
                showLoading(true);
                hideError();
                hideResults();
                
                if (!isConnected) {
                    throw new Error("æœªè¿æ¥åˆ°åŒºå—é“¾ç½‘ç»œï¼Œè¯·å…ˆè¿æ¥");
                }
                
                console.log(`æŸ¥è¯¢ Token ID: ${tokenId} çš„æ± å­ä¿¡æ¯`);
                
                // è°ƒç”¨åˆçº¦çš„ positions å‡½æ•°
                const position = await contract.positions(tokenId);
                console.log("æ± å­ä¿¡æ¯:", position);
                
                // ä¿å­˜å½“å‰æŸ¥è¯¢çš„ position
                currentPosition = position;
                
                // æ˜¾ç¤ºæ± å­ä¿¡æ¯
                document.getElementById('infoTokenId').textContent = tokenId;
                document.getElementById('infoLiquidity').textContent = position.liquidity.toString();
                document.getElementById('infoToken0').textContent = position.token0;
                document.getElementById('infoToken1').textContent = position.token1;
                document.getElementById('infoFee').textContent = `${position.fee / 10000}%`;
                document.getElementById('infoTickLower').textContent = position.tickLower;
                document.getElementById('infoTickUpper').textContent = position.tickUpper;
                
                // æ˜¾ç¤ºå¯å½’é›†çš„æ‰‹ç»­è´¹
                document.getElementById('infoFee0').textContent = position.tokensOwed0.toString();
                document.getElementById('infoFee1').textContent = position.tokensOwed1.toString();
                
                // æ˜¾ç¤ºæ± å­ä¿¡æ¯å’Œæ‰‹ç»­è´¹ä¿¡æ¯
                document.getElementById('poolInfo').classList.add('show');
                document.getElementById('feesInfo').classList.add('show');
                
                // åŒæ­¥å…¶ä»–è¡¨å•çš„ Token ID
                document.getElementById('removeTokenId').value = tokenId;
                document.getElementById('collectTokenId').value = tokenId;
                
                showLoading(false);
                return position;
            } catch (error) {
                console.error("æŸ¥è¯¢æ± å­ä¿¡æ¯å¤±è´¥:", error);
                showError(`æŸ¥è¯¢æ± å­ä¿¡æ¯å¤±è´¥: ${error.message}`);
                showLoading(false);
                return null;
            }
        }

        // ç”Ÿæˆç§»é™¤æµåŠ¨æ€§å‚æ•°
        async function generateRemoveLiquidityParams(tokenId, liquidityPercent, amount0Min, amount1Min) {
            try {
                showLoading(true);
                hideError();
                
                if (!isConnected) {
                    throw new Error("æœªè¿æ¥åˆ°åŒºå—é“¾ç½‘ç»œï¼Œè¯·å…ˆè¿æ¥");
                }
                
                // å¦‚æœæ²¡æœ‰å½“å‰ position ä¿¡æ¯ï¼Œå…ˆæŸ¥è¯¢
                if (!currentPosition) {
                    currentPosition = await queryPosition(tokenId);
                    if (!currentPosition) {
                        throw new Error("æ— æ³•è·å–æ± å­ä¿¡æ¯");
                    }
                }
                
                // è®¡ç®—è¦ç§»é™¤çš„æµåŠ¨æ€§æ•°é‡
                const liquidityToRemove = currentPosition.liquidity.mul(ethers.BigNumber.from(liquidityPercent)).div(ethers.BigNumber.from(100));
                console.log(`è¦ç§»é™¤çš„æµåŠ¨æ€§: ${liquidityToRemove.toString()} (${liquidityPercent}%)`);
                
                // è®¡ç®— deadline (å½“å‰æ—¶é—´ + 20 åˆ†é’Ÿ)
                const deadline = Math.floor(Date.now() / 1000) + 20 * 60;
                
                // æ„é€ å‚æ•°
                const params = {
                    tokenId: tokenId,
                    liquidity: liquidityToRemove.toString(),
                    amount0Min: amount0Min,
                    amount1Min: amount1Min,
                    deadline: deadline
                };
                
                console.log("ç§»é™¤æµåŠ¨æ€§å‚æ•°:", params);
                
                // æ˜¾ç¤ºå‚æ•°
                document.getElementById('paramsValue').textContent = JSON.stringify(params, null, 2);
                document.getElementById('deadlineValue').textContent = deadline.toString();
                
                // æ˜¾ç¤ºç»“æœ
                document.getElementById('results').classList.add('show');
                
                showLoading(false);
                return params;
            } catch (error) {
                console.error("ç”Ÿæˆç§»é™¤æµåŠ¨æ€§å‚æ•°å¤±è´¥:", error);
                showError(`ç”Ÿæˆç§»é™¤æµåŠ¨æ€§å‚æ•°å¤±è´¥: ${error.message}`);
                showLoading(false);
                return null;
            }
        }

        // ç”Ÿæˆå½’é›†æ‰‹ç»­è´¹å‚æ•°
        async function generateCollectFeesParams(tokenId, recipient, amount0Max, amount1Max) {
            try {
                showLoading(true);
                hideError();
                
                if (!isConnected) {
                    throw new Error("æœªè¿æ¥åˆ°åŒºå—é“¾ç½‘ç»œï¼Œè¯·å…ˆè¿æ¥");
                }
                
                // å¦‚æœæ²¡æœ‰å½“å‰ position ä¿¡æ¯ï¼Œå…ˆæŸ¥è¯¢
                if (!currentPosition) {
                    currentPosition = await queryPosition(tokenId);
                    if (!currentPosition) {
                        throw new Error("æ— æ³•è·å–æ± å­ä¿¡æ¯");
                    }
                }
                
                // æ„é€ å‚æ•°ï¼Œä½¿ç”¨ä¼ å…¥çš„amount0Maxå’Œamount1Max
                const params = {
                    tokenId: tokenId,
                    recipient: recipient,
                    amount0Max: amount0Max || ethers.constants.MaxUint128,
                    amount1Max: amount1Max || ethers.constants.MaxUint128
                };
                
                console.log("å½’é›†æ‰‹ç»­è´¹å‚æ•°:", params);
                
                // æ˜¾ç¤ºå‚æ•°
                document.getElementById('paramsValue').textContent = JSON.stringify(params, null, 2);
                document.getElementById('deadlineValue').textContent = "ä¸éœ€è¦ deadline å‚æ•°";
                
                // æ˜¾ç¤ºç»“æœ
                document.getElementById('results').classList.add('show');
                
                showLoading(false);
                return params;
            } catch (error) {
                console.error("ç”Ÿæˆå½’é›†æ‰‹ç»­è´¹å‚æ•°å¤±è´¥:", error);
                showError(`ç”Ÿæˆå½’é›†æ‰‹ç»­è´¹å‚æ•°å¤±è´¥: ${error.message}`);
                showLoading(false);
                return null;
            }
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const textToCopy = element.querySelector('span').textContent;
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                const copyBtn = element.querySelector('.copy-btn');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'å·²å¤åˆ¶!';
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
            });
        }

        // æ˜¾ç¤º/éšè—åŠ è½½ä¸­
        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.add('show');
            } else {
                loading.classList.remove('show');
            }
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const error = document.getElementById('error');
            error.textContent = message;
            error.classList.add('show');
        }

        // éšè—é”™è¯¯ä¿¡æ¯
        function hideError() {
            const error = document.getElementById('error');
            error.classList.remove('show');
        }

        // éšè—ç»“æœ
        function hideResults() {
            document.getElementById('results').classList.remove('show');
        }

        // åˆå§‹åŒ–è®¾ç½®
        function initSettings() {
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½è®¾ç½®
            const savedSettings = localStorage.getItem('v3PositionManagerSettings');
            if (savedSettings) {
                try {
                    currentSettings = JSON.parse(savedSettings);
                    
                    // ç¡®ä¿ç½‘ç»œåç§°æ­£ç¡®è®¾ç½®
                    if (!currentSettings.name && currentSettings.network) {
                        currentSettings.name = networkConfigs[currentSettings.network].name;
                    }
                    
                    console.log("å·²åŠ è½½ä¿å­˜çš„è®¾ç½®:", currentSettings);
                } catch (error) {
                    console.error("è§£æä¿å­˜çš„è®¾ç½®å¤±è´¥:", error);
                    currentSettings = { ...defaultSettings };
                }
            }
            
            // å¡«å……è®¾ç½®è¡¨å•
            document.getElementById('networkSelect').value = currentSettings.network || 'bsc';
            document.getElementById('rpcUrl').value = currentSettings.rpcUrl || networkConfigs.bsc.rpcUrl;
            document.getElementById('contractAddress').value = currentSettings.contractAddress || networkConfigs.bsc.contractAddress;
            
            // åˆå§‹åŒ– Web3 è¿æ¥
            initWeb3();
        }

        // å¤„ç†ç½‘ç»œé€‰æ‹©å˜æ›´
        function handleNetworkChange() {
            const networkSelect = document.getElementById('networkSelect');
            const selectedNetwork = networkSelect.value;
            const networkConfig = networkConfigs[selectedNetwork];
            
            if (networkConfig) {
                document.getElementById('rpcUrl').value = networkConfig.rpcUrl;
                document.getElementById('contractAddress').value = networkConfig.contractAddress;
            }
        }

        // ä¿å­˜è®¾ç½®
        function saveSettings() {
            const networkSelect = document.getElementById('networkSelect');
            const rpcUrl = document.getElementById('rpcUrl').value;
            const contractAddress = document.getElementById('contractAddress').value;
            
            // è·å–é€‰å®šç½‘ç»œçš„é…ç½®
            const selectedNetwork = networkSelect.value;
            const networkConfig = networkConfigs[selectedNetwork];
            
            // æ›´æ–°å½“å‰è®¾ç½®
            currentSettings = {
                network: selectedNetwork,
                name: networkConfig.name,
                rpcUrl: rpcUrl,
                contractAddress: contractAddress,
                explorerUrl: networkConfig.explorerUrl
            };
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('v3PositionManagerSettings', JSON.stringify(currentSettings));
            
            console.log("å·²ä¿å­˜è®¾ç½®:", currentSettings);
            
            // å…³é—­è®¾ç½®å¼¹çª—
            document.getElementById('settingsModal').classList.remove('show');
            
            // æ˜¾ç¤ºç½‘ç»œåˆ‡æ¢çŠ¶æ€
            document.getElementById('networkStatus').textContent = `æ­£åœ¨åˆ‡æ¢åˆ° ${currentSettings.name} ç½‘ç»œ...`;
            
            // é‡æ–°åˆå§‹åŒ– Web3 è¿æ¥
            initWeb3();
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabId) {
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾é¡µçš„ active ç±»
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰å†…å®¹åŒºåŸŸçš„ active ç±»
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ä¸ºé€‰ä¸­çš„æ ‡ç­¾é¡µæ·»åŠ  active ç±»
            document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
            
            // ä¸ºé€‰ä¸­çš„å†…å®¹åŒºåŸŸæ·»åŠ  active ç±»
            document.getElementById(`${tabId}Tab`).classList.add('active');
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // åˆå§‹åŒ–è®¾ç½®
            initSettings();
            
            // è®¾ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('settingsBtn').addEventListener('click', () => {
                document.getElementById('settingsModal').classList.add('show');
            });
            
            // å…³é—­è®¾ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('closeSettingsBtn').addEventListener('click', () => {
                document.getElementById('settingsModal').classList.remove('show');
            });
            
            // å–æ¶ˆè®¾ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('cancelSettingsBtn').addEventListener('click', () => {
                document.getElementById('settingsModal').classList.remove('show');
            });
            
            // ä¿å­˜è®¾ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
            
            // ç½‘ç»œé€‰æ‹©å˜æ›´äº‹ä»¶
            document.getElementById('networkSelect').addEventListener('change', handleNetworkChange);
            
            // æ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    switchTab(tab.getAttribute('data-tab'));
                });
            });
            
            // æŸ¥è¯¢è¡¨å•æäº¤äº‹ä»¶
            document.getElementById('queryForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const tokenId = document.getElementById('queryTokenId').value;
                await queryPosition(tokenId);
            });
            
            // ç§»é™¤æµåŠ¨æ€§è¡¨å•æäº¤äº‹ä»¶
            document.getElementById('removeForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const tokenId = document.getElementById('removeTokenId').value;
                const liquidityPercent = document.getElementById('liquidity').value;
                const amount0Min = document.getElementById('amount0Min').value;
                const amount1Min = document.getElementById('amount1Min').value;
                await generateRemoveLiquidityParams(tokenId, liquidityPercent, amount0Min, amount1Min);
            });
            
            // å½’é›†æ‰‹ç»­è´¹è¡¨å•æäº¤äº‹ä»¶
            document.getElementById('collectForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const tokenId = document.getElementById('collectTokenId').value;
                const recipient = document.getElementById('recipient').value;
                const amount0Max = document.getElementById('amount0Max').value;
                const amount1Max = document.getElementById('amount1Max').value;
                await generateCollectFeesParams(tokenId, recipient, amount0Max, amount1Max);
            });
        });
    </script>
</body>
</html>
